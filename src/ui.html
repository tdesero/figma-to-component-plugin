<!-- syntax highlighting etc. -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.0/beautify.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.0/beautify-css.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.0/beautify-html.js"></script>

<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/styles/vs2015.min.css"
/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/highlight.min.js"></script>
<!-- syntax highlighting etc. end -->

<!-- bootstrap -->
<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
  rel="stylesheet"
  integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
  crossorigin="anonymous"
/>
<script
  src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
  crossorigin="anonymous"
></script>
<!-- bootstrap end -->
<style>
  html {
    font-size: 12px;
  }

  #preview iframe {
    width: 100%;
    height: 350px;
    background: #fff;
  }
</style>

<div class="p-4 bg-light h-100">
  <ul class="nav nav-pills nav-fill mb-3" id="pills-tab" role="tablist">
    <li class="nav-item" role="presentation">
      <button
        class="nav-link active"
        id="pills-home-tab"
        data-bs-toggle="pill"
        data-bs-target="#pills-home"
        type="button"
        role="tab"
        aria-controls="pills-home"
        aria-selected="true"
      >
        Preview
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button
        class="nav-link"
        id="pills-profile-tab"
        data-bs-toggle="pill"
        data-bs-target="#pills-profile"
        type="button"
        role="tab"
        aria-controls="pills-profile"
        aria-selected="false"
      >
        Code
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button
        class="nav-link"
        id="pills-contact-tab"
        data-bs-toggle="pill"
        data-bs-target="#pills-contact"
        type="button"
        role="tab"
        aria-controls="pills-contact"
        aria-selected="false"
      >
        Variables
      </button>
    </li>
  </ul>
  <div class="tab-content" id="pills-tabContent">
    <div
      class="tab-pane fade show active"
      id="pills-home"
      role="tabpanel"
      aria-labelledby="pills-home-tab"
    >
      <div class="border rounded" id="preview">
        <div class="spinner-border text-secondary m-5" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
    </div>
    <div
      class="tab-pane fade"
      id="pills-profile"
      role="tabpanel"
      aria-labelledby="pills-profile-tab"
    >
      <button class="btn btn-secondary btn-sm mb-3" id="copy">
        Copy <span id="framework"></span> code
      </button>
      <pre><code class="hljs rounded" id="code"></code></pre>
    </div>
    <div
      class="tab-pane fade"
      id="pills-contact"
      role="tabpanel"
      aria-labelledby="pills-contact-tab"
    >
      <button class="btn btn-secondary btn-sm mb-3" id="copy-vars">
        Copy variables
      </button>
      <div class="alert alert-primary" role="alert">
        This plugin can't load variables from other files. Please open the file
        and run the plugin there.
      </div>
      <pre><code class="hljs rounded" id="variables"></code></pre>
    </div>
  </div>
</div>

<script>
  /* helpers */
  function toPascalCase(string) {
    return `${string}`
      .replace(new RegExp(/[-_]+/, "g"), " ")
      .replace(new RegExp(/[^\w\s]/, "g"), "")
      .replace(
        new RegExp(/\s+(.)(\w*)/, "g"),
        ($1, $2, $3) => `${$2.toUpperCase() + $3.toLowerCase()}`
      )
      .replace(new RegExp(/\w/), (s) => s.toUpperCase());
  }
  /* helpers end */

  onmessage = (event) => {
    const framework = event.data.pluginMessage.framework;
    const styles = event.data.pluginMessage.styles;

    const variables =
      ":root {\n" +
      "  /* Colors */\n" +
      styles?.paintStyles
        ?.map(({ name, value }) => {
          return `  --${name}: ${value};`;
        })
        .join("\n") +
      "\n\n  /* Fonts */\n" +
      styles?.textStyles
        ?.map(({ name, value }) => {
          return `  --${name}: ${value};`;
        })
        .join("\n") +
      "\n}\n\n";

    const html = html_beautify(event.data.pluginMessage.html, {
      indent_size: "2",
      indent_char: " ",
      max_preserve_newlines: "5",
      preserve_newlines: true,
      keep_array_indentation: false,
      break_chained_methods: false,
      indent_scripts: "normal",
      brace_style: "collapse",
      space_before_conditional: true,
      unescape_strings: false,
      jslint_happy: false,
      end_with_newline: false,
      wrap_line_length: "0",
      indent_inner_html: false,
      comma_first: false,
      e4x: false,
      indent_empty_lines: false,
    });
    const css = css_beautify(event.data.pluginMessage.css, {
      indent_size: "2",
      indent_char: " ",
      max_preserve_newlines: "-1",
      preserve_newlines: false,
      keep_array_indentation: false,
      break_chained_methods: false,
      indent_scripts: "normal",
      brace_style: "collapse",
      space_before_conditional: true,
      unescape_strings: false,
      jslint_happy: false,
      end_with_newline: false,
      wrap_line_length: "0",
      indent_inner_html: false,
      comma_first: false,
      e4x: false,
      indent_empty_lines: false,
    });

    const name = toPascalCase(event.data.pluginMessage.name);

    const highlightedHtml = hljs.highlight(html, { language: "xml" }).value;
    const highlightedCss = hljs.highlight(css, { language: "css" }).value;

    document.querySelector("#framework").innerText = framework;
    document.querySelector("#variables").innerText = styles ? variables : "";

    var iframe = document.createElement("iframe");
    var htmlDoc =
      framework === "tailwind(beta)"
        ? "No preview possible"
        : html + "<style>" + css + "</style>";
    document.querySelector("#preview").innerHTML = "";
    document.querySelector("#preview").appendChild(iframe);
    iframe.contentWindow.document.open();
    iframe.contentWindow.document.write(htmlDoc);
    iframe.contentWindow.document.close();

    switch (framework) {
      case "react":
        document.querySelector("#code").innerText =
          "export const " +
          name +
          " = () => { \nreturn(\n" +
          html.replace(/class=/g, "className=") +
          ")}\n\n" +
          css;
        break;
      case "html":
        document.querySelector("#code").innerHTML =
          highlightedHtml +
          "\n\n" +
          "&lt;style&gt;\n" +
          highlightedCss +
          "\n&lt;/style&gt;";
        break;
      case "tailwind(beta)":
        document.querySelector("#code").innerHTML = highlightedHtml;
        break;
      default:
        return;
    }

    const copyToClipboard = (str) => {
      const el = document.createElement("textarea");
      el.value = str;
      el.setAttribute("readonly", "");
      el.style.position = "absolute";
      el.style.left = "-9999px";
      document.body.appendChild(el);
      const selected =
        document.getSelection().rangeCount > 0
          ? document.getSelection().getRangeAt(0)
          : false;
      el.select();
      document.execCommand("copy");
      document.body.removeChild(el);
      if (selected) {
        document.getSelection().removeAllRanges();
        document.getSelection().addRange(selected);
      }
    };

    document.querySelector("#copy").onclick = () => {
      copyToClipboard(document.querySelector("#code").innerText);
    };

    document.querySelector("#copy-vars").onclick = () => {
      copyToClipboard(document.querySelector("#variables").innerText);
    };
  };
</script>
